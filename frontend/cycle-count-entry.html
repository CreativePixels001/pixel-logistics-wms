<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle Count Entry - Pixel Logistics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .count-entry-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .count-header {
            background: var(--card-bg);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .count-header h2 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }

        .count-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .count-type-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .count-type-card:hover {
            border-color: var(--text-secondary);
            transform: translateY(-2px);
        }

        .count-type-card.selected {
            border-color: var(--text-primary);
            background: var(--hover-bg);
        }

        .count-type-card i {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .count-type-card.selected i {
            color: var(--text-primary);
        }

        .count-type-card .type-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: var(--font-size-sm);
        }

        .count-type-card .type-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .count-form-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .section-title i {
            color: var(--text-secondary);
        }

        .item-lookup {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .item-lookup input {
            flex: 1;
        }

        .item-info-card {
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            display: none;
        }

        .item-info-card.active {
            display: block;
        }

        .item-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .count-input-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
        }

        .count-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--spacing-md);
            align-items: end;
            margin-bottom: var(--spacing-md);
        }

        .variance-indicator {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            font-weight: 600;
            text-align: center;
            font-size: var(--font-size-sm);
        }

        .variance-indicator.none {
            background: var(--hover-bg);
            color: var(--text-secondary);
        }

        .variance-indicator.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .variance-indicator.negative {
            background: #ffebee;
            color: #c62828;
        }

        .dark-theme .variance-indicator.positive {
            background: #1b5e20;
            color: #a5d6a7;
        }

        .dark-theme .variance-indicator.negative {
            background: #b71c1c;
            color: #ef9a9a;
        }

        .reason-code-section {
            display: none;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        .reason-code-section.active {
            display: block;
        }

        .count-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: var(--spacing-md);
        }

        .count-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .count-history-table th {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 1;
        }

        .count-history-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--font-size-sm);
        }

        .count-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        .btn-count-save {
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s ease;
        }

        .btn-count-save:hover {
            opacity: 0.85;
        }

        .btn-count-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auto-save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            background: var(--hover-bg);
        }

        .auto-save-indicator i {
            font-size: 0.625rem;
        }

        .auto-save-indicator.saving {
            color: #f57c00;
        }

        .auto-save-indicator.saved {
            color: #388e3c;
        }

        @media (max-width: 768px) {
            .count-type-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .count-input-group {
                grid-template-columns: 1fr;
            }

            .item-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
  
  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <div class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="4" width="12" height="12" fill="currentColor"/>
          <rect x="4" y="20" width="12" height="12" fill="currentColor"/>
          <rect x="20" y="4" width="12" height="12" fill="currentColor"/>
          <rect x="20" y="20" width="12" height="12" fill="currentColor" opacity="0.5"/>
          <rect x="24" y="24" width="4" height="4" fill="var(--color-white)"/>
        </svg>
        <div>
          <div class="logo-text">Pixel Logistics</div>
          <div class="logo-subtitle">Warehouse Management System</div>
        </div>
      </div>
      
      <div style="flex: 1;"></div>
      
      <!-- Search Trigger Button -->
      <button class="search-trigger" onclick="openSearch()" aria-label="Search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span>Search</span>
        <kbd class="search-kbd-compact">âŒ˜K</kbd>
      </button>
      
      <!-- Theme Toggle Button -->
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="theme-icon theme-icon-light" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="theme-icon theme-icon-dark" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
      
      <!-- Global Search Modal (Hidden by default) -->
      <div class="search-modal" id="searchModal" style="display: none;">
        <div class="search-modal-overlay" onclick="closeSearch()"></div>
        <div class="search-modal-content">
          <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" class="search-input" id="globalSearchInput" placeholder="Search warehouse..." autocomplete="off">
            <button class="search-close" onclick="closeSearch()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
      </div>
      
      <div class="user-menu">
        <div class="user-info">
          <div class="user-name">Admin User</div>
          <div class="user-role">Warehouse Manager</div>
        </div>
        <div class="user-avatar" onclick="toggleUserMenu()">AK</div>
        <div class="user-dropdown" id="userDropdown">
          <a href="#" class="dropdown-item" onclick="viewProfile(); return false;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            My Profile
          </a>
          <a href="#" class="dropdown-item" onclick="changePassword(); return false;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Change Password
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item" onclick="logout(); return false;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </a>
        </div>
      </div>
    </div>
  </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="user-management.html" class="nav-item">
                    <i class="fas fa-users-cog"></i>
                    <span>User Management</span>
                </a>
                <a href="access-control.html" class="nav-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>Access Control</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Inbound</div>
                <a href="receiving.html" class="nav-item">
                    <i class="fas fa-truck-loading"></i>
                    <span>Receiving</span>
                </a>
                <a href="putaway.html" class="nav-item">
                    <i class="fas fa-dolly"></i>
                    <span>Putaway</span>
                </a>
                <a href="quality-control.html" class="nav-item">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Quality Control</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Inventory</div>
                <a href="inventory.html" class="nav-item">
                    <i class="fas fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                <a href="locations.html" class="nav-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Locations</span>
                </a>
                <a href="cycle-count.html" class="nav-item active">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Cycle Count</span>
                </a>
                <a href="stock-transfer.html" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Stock Transfer</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Outbound</div>
                <a href="orders.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="picking.html" class="nav-item">
                    <i class="fas fa-hand-paper"></i>
                    <span>Picking</span>
                </a>
                <a href="packing.html" class="nav-item">
                    <i class="fas fa-box"></i>
                    <span>Packing</span>
                </a>
                <a href="shipping.html" class="nav-item">
                    <i class="fas fa-shipping-fast"></i>
                    <span>Shipping</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Reports</div>
                <a href="reports.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="analytics.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Cycle Count Entry</h1>
                <p class="page-subtitle">Record inventory count and variance</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline" onclick="window.location.href='cycle-count.html'">
                    <i class="fas fa-arrow-left"></i> Back to Cycle Count
                </button>
                <span class="auto-save-indicator" id="autoSaveIndicator">
                    <i class="fas fa-circle"></i> Not saved
                </span>
            </div>

        <div class="count-entry-container">
            <!-- Count Type Selection -->
            <div class="count-header">
                <h2>Select Count Type</h2>
                <div class="count-type-selector">
                    <div class="count-type-card" onclick="selectCountType('full')" data-type="full">
                        <i class="fas fa-warehouse"></i>
                        <div class="type-name">Full Count</div>
                        <div class="type-desc">Complete location count</div>
                    <div class="count-type-card" onclick="selectCountType('partial')" data-type="partial">
                        <i class="fas fa-box-open"></i>
                        <div class="type-name">Partial Count</div>
                        <div class="type-desc">Specific items only</div>
                    <div class="count-type-card" onclick="selectCountType('blind')" data-type="blind">
                        <i class="fas fa-eye-slash"></i>
                        <div class="type-name">Blind Count</div>
                        <div class="type-desc">No system qty shown</div>
                    <div class="count-type-card selected" onclick="selectCountType('abc')" data-type="abc">
                        <i class="fas fa-sort-amount-down"></i>
                        <div class="type-name">ABC Count</div>
                        <div class="type-desc">Priority-based count</div>

            <!-- Count Details Form -->
            <div class="count-form-section">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Count Information
                </div>
                <div class="form-grid grid-cols-3">
                    <div class="form-group">
                        <label for="countId" class="form-label required">Count ID</label>
                        <input type="text" id="countId" class="form-control" value="CC-20241116-001" readonly>
                    </div>
                    <div class="form-group">
                        <label for="location" class="form-label required">Location</label>
                        <input type="text" id="location" class="form-control" placeholder="Scan or enter location" required>
                    </div>
                    <div class="form-group">
                        <label for="countDate" class="form-label required">Count Date</label>
                        <input type="date" id="countDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="counter" class="form-label required">Counter</label>
                        <select id="counter" class="form-control" required>
                            <option value="">Select Counter</option>
                            <option value="user1" selected>Admin User</option>
                            <option value="user2">John Smith</option>
                            <option value="user3">Sarah Johnson</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="countBatch" class="form-label">Batch Number</label>
                        <input type="text" id="countBatch" class="form-control" placeholder="Optional batch">
                    </div>
                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select id="priority" class="form-control">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>

            <!-- Item Lookup -->
            <div class="count-form-section">
                <div class="section-title">
                    <i class="fas fa-search"></i>
                    Item Lookup
                </div>
                <div class="item-lookup">
                    <input type="text" id="itemSearch" class="form-control" placeholder="Scan or enter SKU, UPC, or Item Name">
                    <button class="btn btn-primary" onclick="lookupItem()">
                        <i class="fas fa-search"></i> Lookup
                    </button>
                </div>

                <!-- Item Info Card (Hidden by default) -->
                <div class="item-info-card" id="itemInfoCard">
                    <div class="item-info-grid">
                        <div class="info-item">
                            <span class="info-label">SKU</span>
                            <span class="info-value" id="infoSku">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Item Name</span>
                            <span class="info-value" id="infoName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">UPC</span>
                            <span class="info-value" id="infoUpc">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Category</span>
                            <span class="info-value" id="infoCategory">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">System Quantity</span>
                            <span class="info-value" id="infoSystemQty">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Unit of Measure</span>
                            <span class="info-value" id="infoUom">-</span>
                        </div>

            <!-- Count Entry -->
            <div class="count-form-section">
                <div class="section-title">
                    <i class="fas fa-calculator"></i>
                    Count Entry
                </div>
                <div class="count-input-section">
                    <div class="count-input-group">
                        <div class="form-group">
                            <label for="systemQty" class="form-label">System Quantity</label>
                            <input type="number" id="systemQty" class="form-control" value="0" readonly>
                        </div>
                        <div class="form-group">
                            <label for="countedQty" class="form-label required">Counted Quantity</label>
                            <input type="number" id="countedQty" class="form-control" placeholder="Enter counted quantity" min="0" step="1" oninput="calculateVariance()" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Variance</label>
                            <div class="variance-indicator none" id="varianceIndicator">
                                <div style="font-size: 1.125rem;">0</div>
                                <div style="font-size: 0.625rem; margin-top: 0.125rem;">No variance</div>

                    <!-- Reason Code Section (Shows when variance exists) -->
                    <div class="reason-code-section" id="reasonCodeSection">
                        <div class="form-grid grid-cols-2">
                            <div class="form-group">
                                <label for="reasonCode" class="form-label required">Variance Reason Code</label>
                                <select id="reasonCode" class="form-control">
                                    <option value="">Select reason</option>
                                    <option value="damaged">Damaged Goods</option>
                                    <option value="theft">Theft/Loss</option>
                                    <option value="miscount">Counting Error</option>
                                    <option value="receive_error">Receiving Error</option>
                                    <option value="pick_error">Picking Error</option>
                                    <option value="system_error">System Error</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea id="notes" class="form-control" rows="1" placeholder="Additional comments"></textarea>
                            </div>

                    <div class="form-group">
                        <label for="verifier" class="form-label">Verified By</label>
                        <select id="verifier" class="form-control">
                            <option value="">Select verifier (optional)</option>
                            <option value="user1">Admin User</option>
                            <option value="user2">John Smith</option>
                            <option value="user3">Sarah Johnson</option>
                        </select>
                    </div>

                <div class="count-actions">
                    <button class="btn btn-outline" onclick="resetForm()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                    <button class="btn btn-outline" onclick="saveDraft()">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button class="btn-count-save" onclick="submitCount()" id="submitBtn">
                        <i class="fas fa-check"></i> Submit Count
                    </button>
                </div>

            <!-- Count History -->
            <div class="count-form-section">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    Recent Counts at This Location
                </div>
                <div class="count-history">
                    <table class="count-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>SKU</th>
                                <th>System Qty</th>
                                <th>Counted Qty</th>
                                <th>Variance</th>
                                <th>Counter</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: var(--spacing-lg);">
                                    No recent count history available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
    </main>

    <!-- Upload Sidebar -->
    <div class="upload-sidebar" id="uploadSidebar">
        <div class="upload-header">
            <h3>Upload Files</h3>
            <button class="close-btn" onclick="toggleUploadSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="upload-content">
            <div class="upload-zone" id="uploadZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag and drop files here</p>
                <p class="upload-hint">or click to browse</p>
                <input type="file" id="fileInput" multiple hidden>
            </div>
            <div class="upload-list" id="uploadList"></div>

    <div class="overlay" id="overlay"></div>

    <script src="theme.js"></script>
    <script src="common-header.js"></script>
    <script>
        // Authentication check
        if (!sessionStorage.getItem('isAuthenticated')) {
            window.location.href = 'index.html';
        }

        // Set today's date
        document.getElementById('countDate').valueAsDate = new Date();

        // Sample items database
        const itemsDB = {
            'SKU001': { sku: 'SKU001', name: 'Laptop Dell XPS 15', upc: '123456789012', category: 'Electronics', systemQty: 45, uom: 'EA' },
            'SKU002': { sku: 'SKU002', name: 'Office Chair Ergonomic', upc: '234567890123', category: 'Furniture', systemQty: 28, uom: 'EA' },
            'SKU003': { sku: 'SKU003', name: 'Wireless Mouse Logitech', upc: '345678901234', category: 'Accessories', systemQty: 150, uom: 'EA' },
            'SKU004': { sku: 'SKU004', name: 'Monitor 27" 4K', upc: '456789012345', category: 'Electronics', systemQty: 32, uom: 'EA' },
            'SKU005': { sku: 'SKU005', name: 'Desk Lamp LED', upc: '567890123456', category: 'Accessories', systemQty: 68, uom: 'EA' }
        };

        let autoSaveTimer;
        let currentCountType = 'abc';

        function selectCountType(type) {
            currentCountType = type;
            document.querySelectorAll('.count-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');

            // Hide system quantity for blind count
            const systemQtyGroup = document.getElementById('systemQty').closest('.form-group');
            if (type === 'blind') {
                systemQtyGroup.style.display = 'none';
                document.getElementById('systemQty').value = '***';
            } else {
                systemQtyGroup.style.display = 'block';
            }

            triggerAutoSave();
        }

        function lookupItem() {
            const searchValue = document.getElementById('itemSearch').value.trim().toUpperCase();
            
            if (!searchValue) {
                alert('Please enter a SKU, UPC, or item name');
                return;
            }

            // Search in database
            let foundItem = null;
            for (let key in itemsDB) {
                const item = itemsDB[key];
                if (item.sku === searchValue || item.upc === searchValue || item.name.toUpperCase().includes(searchValue)) {
                    foundItem = item;
                    break;
                }
            }

            if (foundItem) {
                // Populate item info
                document.getElementById('infoSku').textContent = foundItem.sku;
                document.getElementById('infoName').textContent = foundItem.name;
                document.getElementById('infoUpc').textContent = foundItem.upc;
                document.getElementById('infoCategory').textContent = foundItem.category;
                document.getElementById('infoSystemQty').textContent = foundItem.systemQty;
                document.getElementById('infoUom').textContent = foundItem.uom;
                
                // Set system quantity (unless blind count)
                if (currentCountType !== 'blind') {
                    document.getElementById('systemQty').value = foundItem.systemQty;
                }
                
                // Show item info card
                document.getElementById('itemInfoCard').classList.add('active');
                
                // Focus on counted quantity
                document.getElementById('countedQty').focus();
            } else {
                alert('Item not found. Please check the SKU/UPC and try again.');
            }
        }

        function calculateVariance() {
            const systemQty = parseInt(document.getElementById('systemQty').value) || 0;
            const countedQty = parseInt(document.getElementById('countedQty').value) || 0;
            const variance = countedQty - systemQty;

            const indicator = document.getElementById('varianceIndicator');
            const reasonSection = document.getElementById('reasonCodeSection');

            if (variance === 0) {
                indicator.className = 'variance-indicator none';
                indicator.innerHTML = `
                    <div style="font-size: 1.125rem;">0</div>
                    <div style="font-size: 0.625rem; margin-top: 0.125rem;">No variance</div>
                `;
                reasonSection.classList.remove('active');
                document.getElementById('reasonCode').removeAttribute('required');
            } else if (variance > 0) {
                indicator.className = 'variance-indicator positive';
                indicator.innerHTML = `
                    <div style="font-size: 1.125rem;">+${variance}</div>
                    <div style="font-size: 0.625rem; margin-top: 0.125rem;">Overage</div>
                `;
                reasonSection.classList.add('active');
                document.getElementById('reasonCode').setAttribute('required', 'required');
            } else {
                indicator.className = 'variance-indicator negative';
                indicator.innerHTML = `
                    <div style="font-size: 1.125rem;">${variance}</div>
                    <div style="font-size: 0.625rem; margin-top: 0.125rem;">Shortage</div>
                `;
                reasonSection.classList.add('active');
                document.getElementById('reasonCode').setAttribute('required', 'required');
            }

            triggerAutoSave();
        }

        function triggerAutoSave() {
            clearTimeout(autoSaveTimer);
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.className = 'auto-save-indicator saving';
            indicator.innerHTML = '<i class="fas fa-circle"></i> Saving...';

            autoSaveTimer = setTimeout(() => {
                saveDraft(true);
            }, 3000);
        }

        function saveDraft(auto = false) {
            const draftData = {
                countType: currentCountType,
                countId: document.getElementById('countId').value,
                location: document.getElementById('location').value,
                countDate: document.getElementById('countDate').value,
                counter: document.getElementById('counter').value,
                countBatch: document.getElementById('countBatch').value,
                priority: document.getElementById('priority').value,
                itemSearch: document.getElementById('itemSearch').value,
                systemQty: document.getElementById('systemQty').value,
                countedQty: document.getElementById('countedQty').value,
                reasonCode: document.getElementById('reasonCode').value,
                notes: document.getElementById('notes').value,
                verifier: document.getElementById('verifier').value,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('cycleCountDraft', JSON.stringify(draftData));

            const indicator = document.getElementById('autoSaveIndicator');
            indicator.className = 'auto-save-indicator saved';
            indicator.innerHTML = '<i class="fas fa-check-circle"></i> Saved at ' + new Date().toLocaleTimeString();

            if (!auto) {
                alert('Draft saved successfully!');
            }
        }

        function loadDraft() {
            const draft = localStorage.getItem('cycleCountDraft');
            if (draft) {
                const data = JSON.parse(draft);
                
                // Show recovery option
                if (confirm('A draft was found from ' + new Date(data.timestamp).toLocaleString() + '. Do you want to restore it?')) {
                    selectCountType(data.countType);
                    document.getElementById('location').value = data.location;
                    document.getElementById('countDate').value = data.countDate;
                    document.getElementById('counter').value = data.counter;
                    document.getElementById('countBatch').value = data.countBatch;
                    document.getElementById('priority').value = data.priority;
                    document.getElementById('itemSearch').value = data.itemSearch;
                    document.getElementById('systemQty').value = data.systemQty;
                    document.getElementById('countedQty').value = data.countedQty;
                    document.getElementById('reasonCode').value = data.reasonCode;
                    document.getElementById('notes').value = data.notes;
                    document.getElementById('verifier').value = data.verifier;

                    // Recalculate variance
                    if (data.countedQty) {
                        calculateVariance();
                    }
                }
            }
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All unsaved data will be lost.')) {
                document.getElementById('location').value = '';
                document.getElementById('countBatch').value = '';
                document.getElementById('itemSearch').value = '';
                document.getElementById('systemQty').value = '0';
                document.getElementById('countedQty').value = '';
                document.getElementById('reasonCode').value = '';
                document.getElementById('notes').value = '';
                document.getElementById('verifier').value = '';
                document.getElementById('itemInfoCard').classList.remove('active');
                document.getElementById('reasonCodeSection').classList.remove('active');
                document.getElementById('varianceIndicator').className = 'variance-indicator none';
                document.getElementById('varianceIndicator').innerHTML = `
                    <div style="font-size: 1.125rem;">0</div>
                    <div style="font-size: 0.625rem; margin-top: 0.125rem;">No variance</div>
                `;
                
                localStorage.removeItem('cycleCountDraft');
                
                const indicator = document.getElementById('autoSaveIndicator');
                indicator.className = 'auto-save-indicator';
                indicator.innerHTML = '<i class="fas fa-circle"></i> Not saved';
            }
        }

        function validateForm() {
            const location = document.getElementById('location').value.trim();
            const countDate = document.getElementById('countDate').value;
            const counter = document.getElementById('counter').value;
            const countedQty = document.getElementById('countedQty').value;
            const systemQty = parseInt(document.getElementById('systemQty').value) || 0;
            const variance = parseInt(countedQty) - systemQty;

            if (!location) {
                alert('Please enter a location');
                return false;
            }

            if (!countDate) {
                alert('Please select a count date');
                return false;
            }

            if (!counter) {
                alert('Please select a counter');
                return false;
            }

            if (!countedQty) {
                alert('Please enter the counted quantity');
                return false;
            }

            if (variance !== 0) {
                const reasonCode = document.getElementById('reasonCode').value;
                if (!reasonCode) {
                    alert('Please select a reason code for the variance');
                    return false;
                }
            }

            return true;
        }

        function submitCount() {
            if (!validateForm()) {
                return;
            }

            const countData = {
                countId: document.getElementById('countId').value,
                countType: currentCountType,
                location: document.getElementById('location').value,
                countDate: document.getElementById('countDate').value,
                counter: document.getElementById('counter').value,
                countBatch: document.getElementById('countBatch').value,
                priority: document.getElementById('priority').value,
                sku: document.getElementById('infoSku').textContent,
                itemName: document.getElementById('infoName').textContent,
                systemQty: document.getElementById('systemQty').value,
                countedQty: document.getElementById('countedQty').value,
                variance: parseInt(document.getElementById('countedQty').value) - parseInt(document.getElementById('systemQty').value),
                reasonCode: document.getElementById('reasonCode').value,
                notes: document.getElementById('notes').value,
                verifier: document.getElementById('verifier').value,
                submittedAt: new Date().toISOString()
            };

            console.log('Submitting count:', countData);

            // Simulate API call
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            setTimeout(() => {
                alert('Cycle count submitted successfully!\n\nCount ID: ' + countData.countId + '\nVariance: ' + countData.variance);
                localStorage.removeItem('cycleCountDraft');
                window.location.href = 'cycle-count.html';
            }, 1500);
        }

        // Add input listeners for auto-save
        document.getElementById('location').addEventListener('input', triggerAutoSave);
        document.getElementById('countBatch').addEventListener('input', triggerAutoSave);
        document.getElementById('itemSearch').addEventListener('input', triggerAutoSave);
        document.getElementById('reasonCode').addEventListener('change', triggerAutoSave);
        document.getElementById('notes').addEventListener('input', triggerAutoSave);
        document.getElementById('verifier').addEventListener('change', triggerAutoSave);

        // Allow Enter key to lookup item
        document.getElementById('itemSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                lookupItem();
            }
        });

        // Load draft on page load
        window.addEventListener('load', loadDraft);
    </script>
</body>
</html>
